<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tyut.selab.vote.mapper.QueryVoteMapper">
    <resultMap id="voteWeight" type="tyut.selab.vote.domain.po.VoteWeight">
        <result property="voteId" column="vote_id"/>
        <result property="roleId" column="role_id"/>
        <result property="roleName" column="role_name"/>
        <result property="weight" column="weight"/>
    </resultMap>
    <resultMap id="voteOption" type="tyut.selab.vote.domain.vo.VoteOptionVo">
        <result property="id" column="id"/>
        <result property="voteId" column="vote_id"/>
        <result property="optionType" column="option_type"/>
        <result property="content" column="content"/>
    </resultMap>
    <resultMap id="voteInfo" type="tyut.selab.vote.domain.po.VoteInfo">
        <id property="voteId" column="voteId"/>
        <result property="userName" column="nick_name"/>
        <result property="userId" column="user_id"/>
        <result property="voteType" column="vote_type"
                typeHandler="tyut.selab.vote.config.jdbc.handler.VoteTypeHandler"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="status" column="status"
                typeHandler="tyut.selab.vote.config.jdbc.handler.VoteStatusHandler"/>
        <result property="createTime" column="create_time"/>
        <result property="deadTime" column="dead_time"/>
        <result property="optionNum" column="option_num"/>
        <result property="isRealTime" column="is_realtime"/>
        <result property="isComplete" column="is_complete"/>
        <collection property="voteWeights" resultMap="voteWeight"/>
        <collection property="voteOptionVoList" resultMap="voteOption"/>
    </resultMap>
    <select id="getVoteInfoByVoteId" resultMap="voteInfo">
        SELECT
            vu.vote_id,vu.user_id,u.nick_name,v.title,v.content,v.vote_type,v.status,v.dead_time,v.create_time,v.is_realtime,v.option_num,vu.weight,vu.is_complete,vu.role_id,r.role_name
        FROM selab_vote_user vu
                 LEFT JOIN selab_vote_info v  ON v.vote_id = vu.vote_id
                 LEFT JOIN sys_user u ON vu.user_id = u.user_id
                 LEFT JOIN sys_role r ON vu.role_id = r.role_id
        WHERE v.del_flag = 0 AND vu.vote_id = #{voteId} AND v.status = 1
    </select>
    <select id="getMyReport" resultType="tyut.selab.vote.domain.po.VoteRange">
        select
            info.vote_id,
            info.title,
            info.content,
            info.status,
            info.create_time,
            info.dead_time,
            sy.user_name,
            info.user_id
        from selab_vote_report as re
                 left join selab_vote_info as info
                           on re.vote_id= info.vote_id
                 left join sys_user as sy
                           on info.user_id  = sy.user_id
        where report_user_id=#{userId}
    </select>
    <select id="getMyParticipate" resultType="tyut.selab.vote.domain.po.VoteRange">
        select info.vote_id,
               info.title,
               info.content,
               info.status,
               info.create_time,
               info.dead_time,
               sy.user_name,
               info.user_id
        from selab_vote_info as info
                 left join selab_vote_reslut as reslut
                           on reslut.id = info.vote_id
                 left join sys_user as sy
                           on info.user_id = sy.user_id
        where reslut.user_id=#{userId}
    </select>
    <select id="getMyHold" resultType="tyut.selab.vote.domain.po.VoteRange">
        select info.vote_id,
               info.title,
               info.content,
               info.status,
               info.create_time,
               info.dead_time,
               sy.user_name,
               info.user_id
        from selab_vote_info as info
                 left join sys_user as sy
                           on info.user_id = sy.user_id
        where reslut.user_id=#{userId}
    </select>
    <select id="getUntreatedVote" resultType="tyut.selab.vote.domain.po.VoteRange">
        select info.vote_id,
               info.title,
               info.content,
               info.status,
               info.create_time,
               info.dead_time,
               sy.user_name,
               info.user_id
        from selab_vote_info as info
                 left join sys_user as sy
                           on info.user_id = sy.user_id
        where info.status=2
    </select>
    <select id="getVoteById" resultType="tyut.selab.vote.domain.po.VoteRange">
        select info.vote_id,
               info.title,
               info.content,
               info.status,
               info.create_time,
               info.dead_time,
               sy.user_name,
               info.user_id
        from selab_vote_info as info
                 left join sys_user as sy
                           on info.user_id = sy.user_id
        where info.vote_id=#{voteId}
    </select>
    <select id="getIfParticipated" resultType="java.lang.Integer">
        select us.isCompleted
        from selab_vote_user as us
                 left join selab_vote_result as result
                           on us.user_id between result.user_id
        where user_id=#{userId}
    </select>
    <select id="getIfEndedVote" resultType="java.lang.Integer">
        select status
        from selab_vote_info
        where vote_id=#{voteId}
    </select>
    <select id="getAllVote" resultType="tyut.selab.vote.domain.po.VoteRange">
        select info.vote_id,
               info.title,
               info.content,
               info.status,
               info.create_time,
               info.dead_time,
               sy.user_name,
               info.user_id
        from selab_vote_info as info
                 left join sys_user as sy
                           on info.user_id = us.user_id
    </select>
</mapper>